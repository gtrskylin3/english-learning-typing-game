<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EnglishType</title>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&display=swap">
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'JetBrains Mono', monospace;
            background-color: #1a1a1a;
            color: #e2e2e2;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
        }

        .game-container {
            text-align: center;
            background: #2a2a2a;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
            width: 90%;
            max-width: 1400px;
        }

        h1 {
            font-size: 2.5rem;
            margin-bottom: 1rem;
            color: #ffffff;
        }

        a {
            color: #ffffff !important;
            text-decoration: none;
        }

        p {
            font-size: 1.1rem;
            color: #a0a0a0;
            margin-bottom: 1.5rem;
        }

        select,
        button {
            font-family: 'JetBrains Mono', monospace;
            font-size: 1rem;
            padding: 10px 20px;
            margin: 10px;
            border: none;
            border-radius: 8px;
            background: #3a3a3a;
            color: #e2e2e2;
            cursor: pointer;
            transition: background 0.3s;
        }

        select:hover,
        button:hover {
            background: #4a4a4a;
        }

        #toggle-tts-btn {
            background: #10b981;
        }

        #toggle-tts-btn:hover {
            background: #059669;
        }

        #game {
            margin-top: 20px;
        }

        /* #word now shows inline highlighted chars */
        #word {
            font-size: 2.2rem;
            font-weight: 700;
            color: #ffffff;
            margin-bottom: 0.5rem;
            white-space: pre-wrap;
            user-select: none;
            /* prevent selection */
        }

        #translation {
            font-size: 1.2rem;
            color: #6b7280;
            margin-bottom: 1.5rem;
        }

        #author {
            font-size: 1rem;
            color: #a0a0a0;
            font-style: italic;
            margin-bottom: 1.5rem;
            display: none;
        }

        #stats {
            margin-top: 2rem;
            font-size: 1.2rem;
            color: #a0a0a0;
        }

        #stats span {
            color: #10b981;
            font-weight: 700;
        }
        #caps-warning {
            font-size: 1.1rem;
            color: #ef4444;
            margin-bottom: 1rem;
            display: none;
            font-weight: 700;
        }

        .hidden {
            display: none;
        }

        @media (max-width: 600px) {
            .game-container {
                padding: 20px;
            }

            h1 {
                font-size: 1.8rem;
            }

            #word {
                font-size: 1.8rem;
            }
        }
    </style>
</head>

<body>
    <div class="game-container">
        <h1><a href="/" id="home-link">EnglishType</a></h1>
        <p>Изучай английский и тренируй скорость печати!</p>
        <select id="category">
            <option value="short">Короткие слова</option>
            <option value="medium">Средние слова</option>
            <option value="long">Длинные слова</option>
            <option value="quotes">Цитаты</option>
        </select>
        <button id="start-btn">Начать</button>
        <button id="toggle-tts-btn">Озвучка (On)</button>

        <div id="game" class="hidden">
            <div id="caps-warning">Caps Lock включён!</div>
            <div id="word"></div>
            <div id="translation"></div>
            <div id="author"></div>
            <div id="stats">
                Words Typed: <span id="word-count">0</span><br>
                WPM: <span id="wpm">0</span>
                Accuracy: <span id="accuracy">0.00</span>%
            </div>
        </div>
    </div>

    <script>
        /*const API_BASE = 'http://127.0.0.1:8000';*/
        const API_BASE = '';
        let currentWord = '';
        let startTime = null;
        let wordCount = 0;
        let correctCharsTyped = 0;
        let totalCharsTyped = 0;
        let typed = '';
        let isProcessing = false;
        let ttsEnabled = true;
        let activeTypingTime = 0; // Общее время активного ввода в миллисекундах
        let lastWordEndTime = null; // Время завершения последнего слова

        const startBtn = document.getElementById("start-btn");
        const categorySelect = document.getElementById("category");
        const toggleTtsBtn = document.getElementById("toggle-tts-btn");
        const gameDiv = document.getElementById("game");
        const wordEl = document.getElementById("word");
        const translationEl = document.getElementById("translation");
        const authorEl = document.getElementById("author");
        const wordCountEl = document.getElementById("word-count");
        const wpmEl = document.getElementById("wpm");
        const accuracyEl = document.getElementById("accuracy");
        const capsWarningEl = document.getElementById("caps-warning");
        const homeLink = document.getElementById("home-link");

        startBtn.addEventListener('click', startGame);
        toggleTtsBtn.addEventListener('click', toggleTts);
        homeLink.addEventListener('click',  () => {
            speechSynthesis.cancel(); // Stop any ongoing TTS
        });
        function toggleTts() {
            ttsEnabled = !ttsEnabled;
            toggleTtsBtn.textContent = `Озвучка (${ttsEnabled ? 'On' : 'Off'})`;
             if (!ttsEnabled) {
                speechSynthesis.cancel();
            }
        }


        async function startGame() {
            speechSynthesis.cancel();
            startBtn.classList.add('hidden');
            categorySelect.classList.add('hidden');
            toggleTtsBtn.classList.add('hidden');
            gameDiv.classList.remove('hidden');
            wordCount = 0;
            correctCharsTyped = 0;
            totalCharsTyped = 0;
            typed = '';
            isProcessing = false;
            activeTypingTime = 0;
            lastWordEndTime = null;
            updateStats();
            await loadNextWord();
            startTime = new Date();
            document.addEventListener('keydown', handleTyping);
        }


        async function loadNextWord() {
            isProcessing = false;
            typed = '';
            const category = categorySelect.value;
            try {
                const response = await fetch(`${API_BASE}/get_${category}`);
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                const data = await response.json();
                currentWord = category === 'quotes' ? data.quote : data.word;
                renderWord();
                translationEl.textContent = category === 'quotes' ? data.translated_quote : data.translated_word;
                authorEl.textContent = data.author ? `— ${data.author}` : '';
                authorEl.style.display = category === 'quotes' ? 'block' : 'none';
            } catch (error) {
                console.error('Error fetching word:', error);
                translationEl.textContent = 'Error loading word. Try again.';
                wordEl.textContent = '';
                authorEl.style.display = 'none';
                return;
            }

            if (lastWordEndTime) {
                activeTypingTime += new Date() - lastWordEndTime;
            }
            lastWordEndTime = null;
            // Handle TTS separately so it doesn't interfere with fetch errors
            if (ttsEnabled) {
                speakTranslation(translationEl.textContent);
            }
        }

        function renderWord() {
            let html = '';
            for (let i = 0; i < currentWord.length; i++) {
                const char = currentWord[i];
                if (i < typed.length) {
                    if (typed[i] === char) {
                        html += `<span style="color:#10b981">${char}</span>`; // Green for correct
                    } else {
                        html += `<span style="color:#ef4444">${char}</span>`; // Red for mistake
                    }
                } else {
                    html += `<span>${char}</span>`; // Default color for untyped
                }
            }
            wordEl.innerHTML = html;
        }

        async function handleTyping(event) {
            if (isProcessing) return;
            if (event.ctrlKey || event.altKey || event.metaKey) return; // Ignore shortcuts
            
            const capsLockOn = event.getModifierState('CapsLock');
            capsWarningEl.style.display = capsLockOn ? 'block' : 'none';

            if (event.key.length !== 1 && event.key !== 'Backspace') return; // Only chars and backspace

            if (event.key === 'Backspace') {
                if (typed.length > 0) {
                    const wasCorrect = typed[typed.length - 1] === currentWord[typed.length - 1];
                    typed = typed.slice(0, typed.length - 1);

                    // Monkeytype style: don't count backspace in totalCharsTyped
                    // But if we had a correct char, decrease correctCharsTyped
                    if (wasCorrect && correctCharsTyped > 0) {
                        correctCharsTyped--;
                    }
                    // Removed totalCharsTyped-- to penalize accuracy for mistakes/corrections over the entire session
                }
            } else if (typed.length < currentWord.length) {
                // Add character
                typed += event.key;
                totalCharsTyped++;

                // Check if this position is correct
                if (typed.length <= currentWord.length && typed[typed.length - 1] === currentWord[typed.length - 1]) {
                    correctCharsTyped++;
                }
            }

            renderWord();
            updateAccuracy();
            calculateWPM(); // Update WPM in real time

            if (typed === currentWord) {
                wordCount++;
                updateStats();
                isProcessing = true;
                lastWordEndTime = new Date();
                await loadNextWord();
            }
        }

        function speakTranslation(text) {
            speechSynthesis.cancel();
            const utterance = new SpeechSynthesisUtterance(text);
            utterance.lang = 'ru-RU';
            const voices = speechSynthesis.getVoices();
            const russianVoice = voices.find(voice => voice.lang === 'ru-RU');
            if (russianVoice) {
                utterance.voice = russianVoice;
            } else {
                console.warn('Russian voice not found, using default.');
            }
            utterance.rate = 1.0;
            utterance.pitch = 0.8;
            speechSynthesis.speak(utterance);
        }

        window.speechSynthesis.onvoiceschanged = () => {

        };

        function updateStats() {
            wordCountEl.textContent = wordCount;
            calculateWPM();  // ← НОВОЕ: Пересчитываем WPM при каждом обновлении
        }

        function calculateWPM() {
            if (startTime) {
                const now = new Date();
                let totalTime = lastWordEndTime ? activeTypingTime : (now - startTime);
                const minutes = totalTime  / 1000 / 60;
                // Monkeytype formula: (correct characters / 5) / time in minutes
                const wpm = minutes > 0 ? Math.round((correctCharsTyped / 5) / minutes) : 0;
                wpmEl.textContent = wpm;
            }
        }

        function updateAccuracy() {
            // Monkeytype style accuracy: correct chars / total chars typed (not including backspaces)
            const accuracy = totalCharsTyped > 0 ? (correctCharsTyped / totalCharsTyped) * 100 : 100;
            accuracyEl.textContent = accuracy.toFixed(2);
        }
    </script>
</body>

</html>